# Подключение локальной стратегии (Решение)

Все изменения будем производить в файле `libs/passport/strategies/local.js`. 

В [официальной документации](https://github.com/jaredhanson/passport-local#usage) мы видим, что 
конструктор стратегии принимает 2 аргумента - объект с опциями а также функцию, которая проверяет
переданные пользователем значения логина и пароля.

Первым делом нам нужно передать опции для стратегии, в которых указать, что поле запроса, в котором
находится логин пользователя называется `email`:
```js
new LocalStrategy(
  { usernameField: 'email' },
  (email, password, done) => {
    done(null, false, {message: 'Локальная стратегия подключена, но не настроена'});
  }
);
```  

По умолчанию, стратегия настроена таким образом, что проверяет наличие поля `username`, которое 
отсутствует в нашем случае.


Далее переходим к реализации проверяющей функции. Стоит отметить, что всякий результат должен быть
возвращен из этой функции с помощью коллбека `done`. Важно понять и запомнить аргументы этой 
функции:
1. `err` - это первый аргумент, который означает, что в процессе выполнения проверки произошла 
серьезная ошибка, не связанная с логикой проверки. Например, пропало соединение с базой данных.
2. `user` - второй аргумент может содержать либо объект пользователя (если все прошло хорошо), либо
значение `false`, которое будет означать, что какие-то из проверок не пройдены.
3. `info` - это опциональный третий аргумент, в котором мы можем вернуть дополнительную информацию
о результатах проверки, причем как отрицательных (логин или пароль несовпадают), так и 
положительных, если все проверки пройдены.  

Сама логика проверки в нашем случае будет выглядеть следующим образом:
1. Попытаемся найти пользователя по `email` с помощью модели `User`.
2. Если пользователя нет - вернем с помощью коллбека `done` сообщение о том, что пользователь не 
найден.
3. Если пользователь найден то проверим его пароль с помощью функции `checkPassword`.
4. Если пароль неверный - вернем с помощью коллбека `done` сообщение о том, что пароль неверный.
5. Если же пользователь передал верную пару `email:password`, то передадим в коллбек `done` вторым
аргументом объект пользователя.

Для удобства можно использовать `async/await`:
```js
new LocalStrategy(
  { usernameField: 'email' },
  async function(email, password, done) {
    try {
      const user = await User.findOne({email});
      if (!user) {
        return done(null, false, {message: 'Нет такого пользователя'});
      }
      
      const isValidPassword = await user.checkPassword(password);
      
      if (!isValidPassword) {
        return done(null, false, {message: 'Пароль неверен'});
      }
      
      return done(null, user, {message: 'Добро пожаловать!'});
    } catch (err) {
      console.error(err);
      done(err);
    }
  }
);
```
